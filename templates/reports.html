{% extends "base.html" %}

{% block content %}
<h2 class="mb-3">üìä –ü–æ—Å–µ—â–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card text-white bg-primary h-100">
      <div class="card-body">
        <h6 class="card-title">–í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π (–≤ –≤—ã–±–æ—Ä–∫–µ)</h6>
        <h3 class="mb-0">{{ visits|length }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-white bg-success h-100">
      <div class="card-body">
        <h6 class="card-title">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤</h6>
        <h3 class="mb-0">{{ memberships|length }}</h3>
      </div>
    </div>
  </div>
</div>

<h5>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏—è</h5>
<div class="table-responsive mb-4">
  <table class="table table-striped table-sm align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ö–ª–∏–µ–Ω—Ç</th>
        <th>–î–∞—Ç–∞</th>
        <th>–í—Ä–µ–º—è</th>
      </tr>
    </thead>
    <tbody>
      {% for v in visits %}
      <tr>
        <td>{{ v.id }}</td>
        <td>{{ v.name }}</td>
        <td>{{ v.visit_date }}</td>
        <td>{{ v.checkin_time }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<h5>–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã</h5>
<div class="table-responsive mb-4">
  <table class="table table-striped table-sm align-middle">
    <thead>
      <tr>
        <th>–ö–ª–∏–µ–Ω—Ç</th>
        <th>–¢–∏–ø</th>
        <th>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ</th>
        <th>–û—Å—Ç–∞–ª–æ—Å—å –ø–æ—Å–µ—â–µ–Ω–∏–π</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for m in memberships %}
      <tr>
        <td>{{ m.name }}</td>
        <td>{{ m.type }}</td>
        <td>{{ m.end_date }}</td>
        <td>{{ m.visits_left }}</td>
        <td>
          <form method="POST" action="{{ url_for('delete_client', client_id=m.client_id) }}"
                onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ?');">
            <button type="submit" class="btn btn-sm btn-outline-danger">–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<h5>OLAP: –ø–æ—Å–µ—â–µ–Ω–∏—è –ø–æ –¥–Ω—è–º</h5>
<canvas id="visitsChart" height="120"></canvas>

<h5 class="mt-4">–¢–æ–ø‚Äë10 –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —á–∏—Å–ª—É –ø–æ—Å–µ—â–µ–Ω–∏–π</h5>
<ul class="list-group mb-4">
  {% for c in top_clients %}
  <li class="list-group-item d-flex justify-content-between align-items-center">
    {{ c.name }}
    <span class="badge bg-primary rounded-pill">{{ c.visits }}</span>
  </li>
  {% endfor %}
</ul>
<thead>
  <tr>
    <th>–ö–ª–∏–µ–Ω—Ç</th>
    <th>–¢–∏–ø</th>
    <th>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ</th>
    <th>–û—Å—Ç–∞–ª–æ—Å—å –ø–æ—Å–µ—â–µ–Ω–∏–π</th>
    <th>–°—Ç–∞—Ç—É—Å</th>
    <th></th>
  </tr>
</thead>
<tbody>
  {% for m in memberships %}
  <tr>
    <td>{{ m.name }}</td>
    <td>{{ m.type }}</td>
    <td>{{ m.end_date }}</td>
    <td>{{ m.visits_left }}</td>
    <td>{{ m.status }}</td>
    <td>
      <form method="POST" action="{{ url_for('delete_client', client_id=m.client_id) }}"
            onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ?');">
        <button type="submit" class="btn btn-sm btn-outline-danger">–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
      </form>
    </td>
  </tr>
  {% endfor %}
</tbody>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('visitsChart').getContext('2d');
const labels = [{% for row in olap_data %}'{{ row.visit_date }}',{% endfor %}];
const data = [{% for row in olap_data %}{{ row.visits_count }},{% endfor %}];

new Chart(ctx, {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [{
      label: '–ü–æ—Å–µ—â–µ–Ω–∏–π',
      data: data,
      backgroundColor: 'rgba(54, 162, 235, 0.6)'
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: {
        beginAtZero: true
      }
    }
  }
});
</script>
{% endblock %}
